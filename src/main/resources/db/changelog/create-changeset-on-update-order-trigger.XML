<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">
    <!-- Здесь мы позже напишем скрипт -->
        <changeSet id="create_on_order_update_procedure" author="Nicolas">
                <preConditions onFail="MARK_RAN">
                        <tableExists tableName="orders"/>
                </preConditions>
                <createProcedure>
                        CREATE FUNCTION change_order_update_time() RETURNS TRIGGER
                                LANGUAGE plpgsql
            AS $$
                        BEGIN
                 IF
                        OLD!= NEW THEN
                 NEW.order_update=now();
                        END IF;
                        RETURN NEW;
                        END;
$$;
                </createProcedure>
        </changeSet>

        <changeSet id="create_on_order_update_trigger" author="Nicolas">
                <sql>
                        CREATE TRIGGER order_updated_time
                                BEFORE UPDATE
                                ON orders
                                FOR EACH ROW
                                EXECUTE FUNCTION change_order_update_time();
                </sql>
        </changeSet>
</databaseChangeLog>